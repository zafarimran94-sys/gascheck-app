import { useState, useEffect, useRef, useCallback } from "react";

/*‚îÄ‚îÄ‚îÄ Supabase Client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const SB_URL = "https://ybyvhoyiifjfvxcuaeku.supabase.co";
const SB_KEY = "sb_publishable_CeGC_3Qv1Qz14XpYMPgGyA_h3lB67mP";
const APP_NAME = "LPG Inspection Care";

function makeSB(url, key) {
  const hdr = { apikey: key, "Content-Type": "application/json" };
  let at = null, rt = null;
  try { at = localStorage.getItem("gc_at"); rt = localStorage.getItem("gc_rt"); } catch {}
  const sv = (a, r) => { at = a; rt = r; try { a ? (localStorage.setItem("gc_at", a), localStorage.setItem("gc_rt", r)) : (localStorage.removeItem("gc_at"), localStorage.removeItem("gc_rt")); } catch {} };
  const ah = () => ({ ...hdr, Authorization: `Bearer ${at || key}` });
  return {
    auth: {
      async signInWithPassword({ email, password }) { const r = await fetch(`${url}/auth/v1/token?grant_type=password`, { method: "POST", headers: hdr, body: JSON.stringify({ email, password }) }); const d = await r.json(); if (d.access_token) sv(d.access_token, d.refresh_token); return r.ok ? { data: d, error: null } : { data: null, error: d }; },
      async signUp({ email, password, options }) { const r = await fetch(`${url}/auth/v1/signup`, { method: "POST", headers: hdr, body: JSON.stringify({ email, password, data: options?.data || {} }) }); const d = await r.json(); return r.ok ? { data: d, error: null } : { data: null, error: d }; },
      async getUser() { if (!at) return { data: { user: null } }; let r = await fetch(`${url}/auth/v1/user`, { headers: ah() }); if (r.ok) return { data: { user: await r.json() } }; if (rt) { const rr = await fetch(`${url}/auth/v1/token?grant_type=refresh_token`, { method: "POST", headers: hdr, body: JSON.stringify({ refresh_token: rt }) }); if (rr.ok) { const rd = await rr.json(); sv(rd.access_token, rd.refresh_token); return { data: { user: rd.user } }; } } sv(null, null); return { data: { user: null } }; },
      async signOut() { try { await fetch(`${url}/auth/v1/logout`, { method: "POST", headers: ah() }); } catch {} sv(null, null); }
    },
    from(table) {
      let q = "", m = "GET", b = null, sng = false;
      const c = {
        select(cols = "*") { q += `?select=${encodeURIComponent(cols)}`; return c; }, insert(d) { m = "POST"; b = d; return c; }, update(d) { m = "PATCH"; b = d; return c; },
        eq(col, v) { q += `${q.includes("?") ? "&" : "?"}${col}=eq.${v}`; return c; }, order(col, { ascending = true } = {}) { q += `${q.includes("?") ? "&" : "?"}order=${col}.${ascending ? "asc" : "desc"}`; return c; },
        single() { sng = true; return c; },
        then(resolve) { (async () => { try { const h = { ...ah(), Prefer: "return=representation" }; if (sng) h.Accept = "application/vnd.pgrst.object+json"; const o = { method: m, headers: h }; if (b && m !== "GET") o.body = JSON.stringify(b); let u = `${url}/rest/v1/${table}${q}`; if ((m === "POST" || m === "PATCH") && !q.includes("select")) u += (q.includes("?") ? "&" : "?") + "select=*"; const r = await fetch(u, o); if (!r.ok) return resolve({ data: null, error: { message: await r.text() } }); const t = await r.text(); resolve({ data: t ? JSON.parse(t) : null, error: null }); } catch (e) { resolve({ data: null, error: { message: e.message } }); } })(); }
      }; return c;
    }
  };
}
const sb = makeSB(SB_URL, SB_KEY);

/*‚îÄ‚îÄ‚îÄ Icons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const Ic = ({ ch, s = 20, ...p }) => <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>{ch}</svg>;
const II = {
  Back: p => <Ic {...p} ch={<><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></>}/>, Plus: p => <Ic {...p} ch={<><path d="M12 5v14"/><path d="M5 12h14"/></>}/>,
  Search: p => <Ic {...p} ch={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></>}/>, Pin: p => <Ic {...p} ch={<><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0116 0Z"/><circle cx="12" cy="10" r="3"/></>}/>,
  Ok: p => <Ic {...p} ch={<path d="M20 6 9 17l-5-5"/>}/>, No: p => <Ic {...p} ch={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>}/>,
  Cam: p => <Ic {...p} ch={<><path d="M14.5 4h-5L7 7H4a2 2 0 00-2 2v9a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>}/>,
  Share: p => <Ic {...p} ch={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="m8.59 13.51 6.83 3.98"/><path d="m15.41 6.51-6.82 3.98"/></>}/>,
  Print: p => <Ic {...p} ch={<><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>}/>,
  Eye: p => <Ic {...p} ch={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>}/>,
  User: p => <Ic {...p} ch={<><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></>}/>,
  File: p => <Ic {...p} ch={<><path d="M15 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7Z"/><path d="M14 2v4a2 2 0 002 2h4"/></>}/>,
  Play: p => <Ic {...p} ch={<><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></>}/>,
  Clock: p => <Ic {...p} ch={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>}/>,
  Warn: p => <Ic {...p} ch={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>}/>,
  QR: p => <Ic {...p} ch={<><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/></>}/>,
  Out: p => <Ic {...p} ch={<><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>}/>,
  Spin: p => <Ic {...p} ch={<path d="M21 12a9 9 0 11-6.219-8.56"/>}/>,
  Key: p => <Ic {...p} ch={<><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.3 9.3"/><path d="m18 5 3-3"/><path d="M15 8l-2 2"/></>}/>,
  Edit: p => <Ic {...p} ch={<><path d="M17 3a2.85 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></>}/>,
  Pdf: p => <Ic {...p} ch={<><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M10 13H8v4h2v-1.5"/><path d="M14 13h-2v4h2a1 1 0 001-1v-2a1 1 0 00-1-1z"/><path d="M18 13h-2v4"/><path d="M18 15h-1.5"/></>}/>,
  Loc: p => <Ic {...p} ch={<><path d="M12 2a7 7 0 017 7c0 5.25-7 13-7 13S5 14.25 5 9a7 7 0 017-7z"/><circle cx="12" cy="9" r="2.5"/></>}/>,
};

/*‚îÄ‚îÄ‚îÄ Theme Colors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const C = { pri: "#0f2557", priL: "#1a3a7a", red: "#dc2626", redL: "#fef2f2", bg: "#f0f4f8" };

/*‚îÄ‚îÄ‚îÄ Shared Components ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const SBadge = ({ s }) => <span className={`inline-flex items-center px-2.5 py-1 rounded-md text-[11px] font-bold tracking-wide ${{ pending:"bg-amber-100 text-amber-800","in-progress":"bg-sky-100 text-sky-800",completed:"bg-emerald-100 text-emerald-800","customer-not-reachable":"bg-red-100 text-red-800","customer-refused":"bg-rose-100 text-rose-800",rescheduled:"bg-violet-100 text-violet-800" }[s] || "bg-gray-100"}`}>{{ pending:"PENDING","in-progress":"IN PROGRESS",completed:"COMPLETED","customer-not-reachable":"NOT REACHABLE","customer-refused":"REFUSED",rescheduled:"RESCHEDULED" }[s]||s}</span>;
const Bdg = ({ children, v }) => <span className={`inline-flex items-center px-2.5 py-0.5 rounded-md text-[11px] font-semibold ${{ outline:"border border-slate-300 text-slate-600", success:"bg-emerald-100 text-emerald-800", danger:"bg-red-100 text-red-800" }[v] || "bg-slate-800 text-white"}`}>{children}</span>;
const Tabs = ({ tabs, a, set }) => <div className="flex bg-white rounded-lg p-1 gap-1 border border-slate-200">{tabs.map(t => <button key={t.k} onClick={() => set(t.k)} className={`flex-1 py-2.5 px-3 rounded-md text-sm font-semibold transition ${a === t.k ? "text-white shadow-sm" : "text-slate-500 hover:text-slate-700"}`} style={a===t.k?{background:C.pri}:{}}>{t.l}</button>)}</div>;
function Modal({ open, close, title, wide, children }) { if (!open) return null; return <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={close}><div className="absolute inset-0 bg-black/50 backdrop-blur-sm"/><div className={`relative bg-white rounded-2xl shadow-2xl w-full ${wide?"max-w-2xl":"max-w-md"} max-h-[90vh] overflow-y-auto`} onClick={e=>e.stopPropagation()}><div className="sticky top-0 bg-white rounded-t-2xl border-b px-6 py-4 flex items-center justify-between z-10"><h3 className="text-lg font-bold text-slate-900">{title}</h3><button onClick={close} className="p-1.5 rounded-lg hover:bg-slate-100 transition"><II.No s={18}/></button></div><div className="p-6">{children}</div></div></div>; }
function Toast({ msg, type, onClose }) { useEffect(() => { const t = setTimeout(onClose, 3500); return () => clearTimeout(t); }, []); return <div className={`fixed top-4 right-4 z-[100] ${type==="error"?"bg-red-600":type==="success"?"bg-emerald-600":"bg-slate-800"} text-white px-5 py-3 rounded-xl shadow-2xl text-sm font-medium max-w-xs`}>{msg}</div>; }
const Inp = ({ label, required, ...p }) => <div><label className="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">{label}{required && <span className="text-red-500 ml-0.5">*</span>}</label><input className="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" {...p}/></div>;
const Sel = ({ label, required, children, ...p }) => <div><label className="block text-xs font-semibold text-slate-600 mb-1.5 uppercase tracking-wide">{label}{required && <span className="text-red-500 ml-0.5">*</span>}</label><select className="w-full px-4 py-3 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" {...p}>{children}</select></div>;

/*‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function Login({ onOk }) {
  const [em, setEm] = useState(""); const [pw, setPw] = useState(""); const [ld, setLd] = useState(false); const [err, setErr] = useState("");
  const go = async () => { setErr(""); setLd(true); const { data, error } = await sb.auth.signInWithPassword({ email: em, password: pw }); if (error) { setErr(error.error_description || error.msg || JSON.stringify(error)); setLd(false); return; } onOk(data.user); setLd(false); };
  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{ background: `linear-gradient(135deg,${C.pri} 0%,#1a3a7a 50%,${C.pri} 100%)` }}>
      <div className="w-full max-w-sm">
        <div className="text-center mb-8"><div className="w-16 h-16 rounded-2xl bg-white/10 border border-white/20 flex items-center justify-center mx-auto mb-4"><II.Loc s={32} className="text-white"/></div><h1 className="text-2xl font-extrabold text-white tracking-tight">{APP_NAME}</h1><p className="text-blue-200/70 text-sm mt-1">Safety Inspection Management</p></div>
        <div className="bg-white rounded-2xl p-6 shadow-2xl">
          {err && <div className="bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg px-4 py-3 mb-4">{err}</div>}
          <div className="space-y-4">
            <Inp label="Email" type="email" value={em} onChange={e=>setEm(e.target.value)} placeholder="you@company.com" onKeyDown={e=>e.key==="Enter"&&go()}/>
            <Inp label="Password" type="password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onKeyDown={e=>e.key==="Enter"&&go()}/>
            <button onClick={go} disabled={ld||!em||!pw} className="w-full py-3.5 text-white rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 disabled:opacity-40 hover:opacity-90" style={{background:C.pri}}>{ld && <II.Spin s={18} className="animate-spin"/>}{ld?"Signing in...":"Sign In"}</button>
          </div>
        </div>
      </div>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Data Hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function useData() {
  const [emps, setEmps] = useState([]); const [jobs, setJobs] = useState([]); const [loading, setLoading] = useState(true); const [toast, setToast] = useState(null);
  const show = (msg, type = "info") => setToast({ msg, type });
  const load = useCallback(async () => { setLoading(true); const [er, jr] = await Promise.all([ sb.from("employees").select("*").eq("is_active", true).order("name"), sb.from("jobs").select("*").order("created_at", { ascending: false }) ]); if (er.data) setEmps(er.data); if (jr.data) setJobs(jr.data); setLoading(false); }, []);
  useEffect(() => { load(); }, [load]);
  const addEmp = async (e) => { const { data, error } = await sb.from("employees").insert(e); if (error) { show(error.message, "error"); return null; } if (data?.[0]) setEmps(p => [...p, data[0]]); show("Employee added!", "success"); return data?.[0]; };
  const addJob = async (j) => { const { data, error } = await sb.from("jobs").insert(j); if (error) { show(error.message, "error"); return; } if (data?.[0]) setJobs(p => [data[0], ...p]); show("Job created!", "success"); };
  const addBulk = async (list) => { const { data, error } = await sb.from("jobs").insert(list); if (error) { show(error.message, "error"); return; } if (data) setJobs(p => [...data, ...p]); show(`${data?.length||0} jobs added!`, "success"); };
  const updJob = async (id, u) => { const { data, error } = await sb.from("jobs").update(u).eq("id", id); if (error) { show(error.message, "error"); return; } if (data?.[0]) setJobs(p => p.map(j => j.id === id ? data[0] : j)); show("Job updated", "success"); };
  return { emps, jobs, loading, addEmp, addJob, addBulk, updJob, load, toast, setToast, show };
}

/*‚îÄ‚îÄ‚îÄ Job Form (shared for create & edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const emptyJob = { address:"", area:"", customer_name:"", customer_phone:"", gas_company_name:"", gas_agency_name:"", assigned_to:"" };
function JobForm({ job, emps, onSave, onClose, isEdit }) {
  const [f, setF] = useState(job ? { address:job.address||"", area:job.area||"", customer_name:job.customer_name||"", customer_phone:job.customer_phone||"", gas_company_name:job.gas_company_name||"", gas_agency_name:job.gas_agency_name||"", assigned_to:job.assigned_to||"" } : { ...emptyJob });
  const [ld, setLd] = useState(false);
  const go = async () => { if(!f.address||!f.area||!f.assigned_to) return; setLd(true); await onSave(f); setLd(false); };
  return (
    <div className="space-y-3">
      <Inp label="Address" required value={f.address} onChange={e=>setF({...f,address:e.target.value})} placeholder="House 21, Sector 9"/>
      <div className="grid grid-cols-2 gap-3"><Inp label="Area" required value={f.area} onChange={e=>setF({...f,area:e.target.value})} placeholder="West Zone"/><Inp label="Customer Name" value={f.customer_name} onChange={e=>setF({...f,customer_name:e.target.value})} placeholder="Sharma ji"/></div>
      <div className="grid grid-cols-2 gap-3"><Inp label="Customer Phone" value={f.customer_phone} onChange={e=>setF({...f,customer_phone:e.target.value})} placeholder="9876543210"/><Inp label="Gas Company" value={f.gas_company_name} onChange={e=>setF({...f,gas_company_name:e.target.value})} placeholder="IGL"/></div>
      <Inp label="Gas Agency" value={f.gas_agency_name} onChange={e=>setF({...f,gas_agency_name:e.target.value})} placeholder="Delhi Gas Agency"/>
      <Sel label="Assign To" required value={f.assigned_to} onChange={e=>setF({...f,assigned_to:e.target.value})}><option value="">Select employee...</option>{emps.map(e=><option key={e.id} value={e.id}>{e.name} ‚Äî {e.area}</option>)}</Sel>
      <button onClick={go} disabled={ld||!f.address||!f.area||!f.assigned_to} className="w-full py-3 text-white rounded-lg font-semibold text-sm disabled:opacity-40 mt-2 flex items-center justify-center gap-2" style={{background:C.pri}}>{ld?<II.Spin s={18} className="animate-spin"/>:null}{isEdit?"Save Changes":"Create Job"}</button>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Create Employee Account Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function CreateEmpAccountModal({ open, close, employees, show }) {
  const [selEmp, setSelEmp] = useState(""); const [email, setEmail] = useState(""); const [pw, setPw] = useState(""); const [ld, setLd] = useState(false); const [done, setDone] = useState(null);
  const unlinked = employees.filter(e => !e.profile_id);
  const create = async () => { if (!selEmp||!email||!pw) return; const emp = employees.find(e=>e.id===selEmp); setLd(true); const { data, error } = await sb.auth.signUp({ email, password: pw, options: { data: { full_name: emp.name, phone: emp.phone, role: "employee" } } }); if (error) { show(error.error_description||error.msg||JSON.stringify(error), "error"); setLd(false); return; } const userId = data?.user?.id||data?.id; if (userId) { await sb.from("employees").update({ profile_id: userId }).eq("id", selEmp); await sb.from("profiles").update({ role: "employee" }).eq("id", userId); } setDone({ name: emp.name, email, pw }); show("Account created!", "success"); setLd(false); };
  const reset = () => { setSelEmp(""); setEmail(""); setPw(""); setDone(null); };
  return (
    <Modal open={open} close={()=>{reset();close();}} title="Create Employee Login">
      {done ? <div className="space-y-4"><div className="bg-emerald-50 border-2 border-emerald-400 rounded-xl p-5 text-center"><h3 className="text-lg font-bold text-emerald-800">Account Created!</h3></div><div className="bg-slate-50 rounded-xl p-4 space-y-2 text-sm">{[["Name",done.name],["Email",done.email],["Password",done.pw]].map(([l,v])=><div key={l} className="flex justify-between"><span className="text-slate-500">{l}:</span><span className="font-mono font-medium">{v}</span></div>)}</div><button onClick={()=>{const msg=`${APP_NAME}\n\nApp: ${window.location.origin}\n\nLogin:\nEmail: ${done.email}\nPassword: ${done.pw}`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,"_blank");}} className="w-full py-3 bg-emerald-600 text-white rounded-lg font-semibold text-sm flex items-center justify-center gap-2"><II.Share s={16}/>Share on WhatsApp</button><button onClick={()=>{reset();close();}} className="w-full py-3 border border-slate-200 rounded-lg text-sm font-semibold text-slate-600">Done</button></div>
      : <div className="space-y-4"><Sel label="Employee" required value={selEmp} onChange={e=>{setSelEmp(e.target.value);const emp=employees.find(x=>x.id===e.target.value);if(emp)setEmail(`${emp.name.toLowerCase().replace(/\s+/g,".")}@lpginspection.app`);}}><option value="">Choose...</option>{unlinked.map(e=><option key={e.id} value={e.id}>{e.name} ‚Äî {e.area}</option>)}{unlinked.length===0&&<option disabled>All have accounts</option>}</Sel><Inp label="Email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="ramesh@lpginspection.app"/><Inp label="Password" value={pw} onChange={e=>setPw(e.target.value)} placeholder="simple123"/>{pw&&pw.length<6&&<p className="text-xs text-red-500">Min 6 characters</p>}<button onClick={create} disabled={ld||!selEmp||!email||pw.length<6} className="w-full py-3 text-white rounded-lg font-semibold text-sm disabled:opacity-40 flex items-center justify-center gap-2" style={{background:C.pri}}>{ld?<II.Spin s={18} className="animate-spin"/>:<II.Key s={16}/>}{ld?"Creating...":"Create Login"}</button></div>}
    </Modal>
  );
}

/*‚îÄ‚îÄ‚îÄ Admin Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function Admin({ emps, jobs, onAddEmp, onAddJob, onBulk, onUpdJob, onRecon, onViewEmp, onLogout, prof, show }) {
  const [showE, setShowE] = useState(false); const [showJ, setShowJ] = useState(false); const [showAcct, setShowAcct] = useState(false); const [editJob, setEditJob] = useState(null);
  const [tab, setTab] = useState("jobs"); const [jTab, setJTab] = useState("single");
  const [nE, setNE] = useState({ name:"", phone:"", area:"" });
  const [bulk, setBulk] = useState("");
  const tot=jobs.length,done=jobs.filter(j=>j.status==="completed").length,pend=jobs.filter(j=>j.status==="pending"||j.status==="in-progress").length;
  const cash=jobs.filter(j=>j.payment_type==="cash").reduce((s,j)=>s+(+j.payment_amount||0),0);
  const upi=jobs.filter(j=>j.payment_type==="upi").reduce((s,j)=>s+(+j.payment_amount||0),0);
  const eName=id=>emps.find(e=>e.id===id)?.name||"‚Äî";
  const doAddE=async()=>{if(nE.name&&nE.phone&&nE.area){await onAddEmp(nE);setNE({name:"",phone:"",area:""});setShowE(false);}};
  const doBulk=async()=>{
    const arr=[]; bulk.trim().split("\n").forEach(l=>{const parts=l.split(",").map(s=>s.trim()); if(parts.length<3) return; const [addr,area,custName,custPhone,gasCo,gasAg,empName]=parts; const e=emps.find(x=>x.name===empName||x.id===empName); if(addr&&area&&e) arr.push({address:addr,area,customer_name:custName||null,customer_phone:custPhone||null,gas_company_name:gasCo||null,gas_agency_name:gasAg||null,assigned_to:e.id});});
    if(arr.length){await onBulk(arr);setBulk("");setShowJ(false);}else{show("No valid rows found. Check format.","error");}
  };
  const handleEditSave=async(f)=>{await onUpdJob(editJob.id,f);setEditJob(null);};

  return (
    <div className="min-h-screen" style={{background:C.bg}}>
      <header className="sticky top-0 z-30 border-b border-slate-200" style={{background:"rgba(255,255,255,0.92)",backdropFilter:"blur(12px)"}}><div className="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><div className="flex items-center gap-3"><div className="w-9 h-9 rounded-lg flex items-center justify-center" style={{background:C.pri}}><II.Loc s={18} className="text-white"/></div><div><h1 className="text-xl font-extrabold" style={{color:C.pri}}>{APP_NAME}</h1><p className="text-xs text-slate-500">Welcome, {prof?.full_name||"Admin"}</p></div></div><div className="flex gap-2"><button onClick={onRecon} className="flex items-center gap-2 px-4 py-2.5 text-white rounded-lg text-sm font-semibold transition hover:opacity-90" style={{background:C.pri}}><II.File s={16}/>Reconciliation</button><button onClick={onLogout} className="p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 transition"><II.Out s={16} className="text-slate-500"/></button></div></div></header>
      <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6">
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
          {[{l:"Total Jobs",v:tot,bg:C.pri,i:"üìã"},{l:"Completed",v:done,bg:"#059669",i:"‚úÖ"},{l:"Cash",v:`‚Çπ${cash}`,bg:"#b45309",i:"üíµ"},{l:"UPI",v:`‚Çπ${upi}`,bg:"#7c3aed",i:"üì±"}].map((s,i)=><div key={i} className="rounded-xl p-4 sm:p-5 text-white shadow-md" style={{background:s.bg}}><div className="flex justify-between items-start mb-2"><span className="text-[10px] font-bold uppercase tracking-wider opacity-80">{s.l}</span><span className="text-lg">{s.i}</span></div><div className="text-2xl sm:text-3xl font-extrabold">{s.v}</div>{s.l==="Completed"&&<div className="text-xs opacity-70 mt-1">Pending: {pend}</div>}</div>)}
        </div>
        <Tabs tabs={[{k:"jobs",l:`Jobs (${tot})`},{k:"employees",l:`Employees (${emps.length})`}]} a={tab} set={setTab}/>
        {tab==="jobs"&&<div className="mt-4"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-slate-900">All Jobs</h2><button onClick={()=>setShowJ(true)} className="flex items-center gap-2 px-4 py-2.5 text-white rounded-lg text-sm font-semibold shadow hover:opacity-90" style={{background:C.pri}}><II.Plus s={16}/>Create Job</button></div>
          <div className="bg-white rounded-xl shadow-sm border overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="bg-slate-50 border-b"><th className="text-left p-3 font-semibold text-slate-600 text-xs uppercase">Address</th><th className="text-left p-3 font-semibold text-slate-600 text-xs uppercase hidden sm:table-cell">Area</th><th className="text-left p-3 font-semibold text-slate-600 text-xs uppercase hidden md:table-cell">Assigned</th><th className="text-left p-3 font-semibold text-slate-600 text-xs uppercase">Status</th><th className="text-left p-3 font-semibold text-slate-600 text-xs uppercase">Payment</th><th className="p-3 w-10"></th></tr></thead>
            <tbody>{jobs.map(j=><tr key={j.id} className="border-b border-slate-100 hover:bg-slate-50/50"><td className="p-3"><div className="font-medium text-sm">{j.address}</div>{j.customer_name&&<div className="text-xs text-slate-500 mt-0.5">{j.customer_name}</div>}</td><td className="p-3 text-slate-600 hidden sm:table-cell">{j.area}</td><td className="p-3 text-slate-600 hidden md:table-cell">{eName(j.assigned_to)}</td><td className="p-3"><SBadge s={j.status}/></td><td className="p-3">{j.payment_amount?<div><div className="font-bold">‚Çπ{j.payment_amount}</div><div className="text-xs text-slate-500 uppercase">{j.payment_type}</div></div>:<span className="text-slate-300">‚Äî</span>}</td><td className="p-3"><button onClick={()=>setEditJob(j)} className="p-1.5 rounded-lg hover:bg-slate-100 transition" title="Edit"><II.Edit s={16} className="text-slate-400"/></button></td></tr>)}{jobs.length===0&&<tr><td colSpan={6} className="p-12 text-center text-slate-400">No jobs yet</td></tr>}</tbody></table></div></div></div>}
        {tab==="employees"&&<div className="mt-4"><div className="flex justify-between items-center mb-4 flex-wrap gap-2"><h2 className="text-lg font-bold">Field Workers</h2><div className="flex gap-2"><button onClick={()=>setShowAcct(true)} className="flex items-center gap-2 px-4 py-2.5 text-white rounded-lg text-sm font-semibold shadow hover:opacity-90" style={{background:C.red}}><II.Key s={16}/>Create Login</button><button onClick={()=>setShowE(true)} className="flex items-center gap-2 px-4 py-2.5 text-white rounded-lg text-sm font-semibold shadow hover:opacity-90" style={{background:C.pri}}><II.Plus s={16}/>Add Employee</button></div></div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{emps.map(e=>{const ej=jobs.filter(j=>j.assigned_to===e.id),dn=ej.filter(j=>j.status==="completed").length,pd=ej.filter(j=>j.status==="pending"||j.status==="in-progress").length,col=ej.reduce((s,j)=>s+(+j.payment_amount||0),0); return <div key={e.id} className="bg-white rounded-xl shadow-sm border p-5 hover:shadow-md transition"><div className="flex items-start justify-between mb-4"><div><h3 className="font-bold text-base">{e.name}</h3><p className="text-sm text-slate-500">{e.phone}</p><p className="text-sm text-slate-500 flex items-center gap-1 mt-0.5"><II.Pin s={14}/>{e.area}</p></div><div className="flex flex-col items-end gap-1.5"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{background:"#e8edf5"}}><II.User s={20} style={{color:C.pri}}/></div>{e.profile_id?<span className="text-[10px] px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded font-semibold">Has Login</span>:<span className="text-[10px] px-2 py-0.5 bg-slate-100 text-slate-500 rounded font-semibold">No Login</span>}</div></div><div className="grid grid-cols-3 gap-2 text-center mb-4">{[{v:ej.length,l:"Total",c:"bg-slate-50"},{v:dn,l:"Done",c:"bg-emerald-50"},{v:pd,l:"Pending",c:"bg-amber-50"}].map((d,i)=><div key={i} className={`${d.c} rounded-lg py-2`}><div className="text-lg font-bold">{d.v}</div><div className="text-[10px] text-slate-500 uppercase">{d.l}</div></div>)}</div>{col>0&&<p className="text-sm text-center mb-3 font-medium">Collected: <span className="text-emerald-600 font-bold">‚Çπ{col}</span></p>}<button onClick={()=>onViewEmp(e.id)} className="w-full py-2.5 border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 hover:border-blue-400 hover:text-blue-600 transition flex items-center justify-center gap-2"><II.Eye s={16}/>View Screen</button></div>})}</div></div>}
      </div>
      <Modal open={showE} close={()=>setShowE(false)} title="Add Employee"><div className="space-y-4">{[{k:"name",l:"Name",p:"Ramesh Kumar"},{k:"phone",l:"Phone",p:"9876543210"},{k:"area",l:"Area",p:"West Zone"}].map(f=><Inp key={f.k} label={f.l} required value={nE[f.k]} onChange={e=>setNE({...nE,[f.k]:e.target.value})} placeholder={f.p}/>)}<button onClick={doAddE} className="w-full py-3 text-white rounded-lg font-semibold text-sm" style={{background:C.pri}}>Add Employee</button></div></Modal>
      <Modal open={showJ} close={()=>setShowJ(false)} title="Create Job" wide>
        <Tabs tabs={[{k:"single",l:"Single Job"},{k:"bulk",l:"Bulk Upload"}]} a={jTab} set={setJTab}/>
        {jTab==="single"?<div className="mt-4"><JobForm emps={emps} onSave={async f=>{await onAddJob(f);setShowJ(false);}} onClose={()=>setShowJ(false)}/></div>
        :<div className="mt-4 space-y-3"><div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-800"><p className="font-semibold mb-1">CSV Format (7 columns):</p><p className="font-mono">address, area, customer_name, customer_phone, gas_company, gas_agency, employee_name</p></div><textarea className="w-full px-3 py-3 border border-slate-200 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" rows={8} value={bulk} onChange={e=>setBulk(e.target.value)} placeholder={"House 21, West Zone, Sharma ji, 9876543210, IGL, Delhi Gas, Ramesh Kumar\nFlat 305, East Zone, Gupta, 9876543211, IGL, East Gas, Suresh Patel"}/><button onClick={doBulk} className="w-full py-3 text-white rounded-lg font-semibold text-sm" style={{background:C.pri}}>Upload Jobs</button></div>}
      </Modal>
      <Modal open={!!editJob} close={()=>setEditJob(null)} title="Edit Job" wide>{editJob&&<JobForm job={editJob} emps={emps} isEdit onSave={handleEditSave} onClose={()=>setEditJob(null)}/>}</Modal>
      <CreateEmpAccountModal open={showAcct} close={()=>setShowAcct(false)} employees={emps} show={show}/>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Employee Interface ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function EmpView({ emp, jobs, onStart, onBack, onLogout, isDirectLogin }) {
  const [q, setQ] = useState("");
  if (!emp) return <div className="min-h-screen flex items-center justify-center" style={{background:C.bg}}><div className="text-center p-8 bg-white rounded-xl shadow"><p className="text-slate-500 mb-4">Employee not found</p>{onBack&&<button onClick={onBack} className="px-6 py-2 text-white rounded-lg text-sm font-semibold" style={{background:C.pri}}>Back</button>}</div></div>;
  const f=l=>l.filter(j=>j.address.toLowerCase().includes(q.toLowerCase())||(j.customer_name||"").toLowerCase().includes(q.toLowerCase())||(j.customer_phone||"").includes(q)||j.area.toLowerCase().includes(q.toLowerCase()));
  const pend=f(jobs.filter(j=>j.status==="pending"||j.status==="in-progress")),comp=f(jobs.filter(j=>j.status==="completed")),oth=f(jobs.filter(j=>!["pending","in-progress","completed"].includes(j.status)));
  return (
    <div className="min-h-screen" style={{background:C.bg}}>
      <div className="px-5 pt-4 pb-8" style={{background:`linear-gradient(135deg,${C.pri},#1a3a7a)`}}>
        <div className="max-w-2xl mx-auto">
          <div className="flex justify-between items-start mb-5">{onBack?<button onClick={onBack} className="flex items-center gap-1.5 text-white/70 hover:text-white text-sm"><II.Back s={18}/>Admin</button>:<div/>}{isDirectLogin&&<button onClick={onLogout} className="p-2.5 bg-white/10 rounded-lg hover:bg-white/20 transition"><II.Out s={18} className="text-white"/></button>}</div>
          <h1 className="text-2xl font-extrabold text-white mb-1">Namaste, {emp.name} üôè</h1>
          <p className="text-blue-200/80 text-sm mb-6">‡§Ü‡§ú ‡§ï‡•á ‡§ï‡§æ‡§Æ / Today's Work</p>
          <div className="flex gap-4">
            <div className="bg-white/10 backdrop-blur rounded-xl px-5 py-4 text-white flex-1"><div className="text-[11px] uppercase tracking-wider opacity-60 mb-1">Pending / ‡§¨‡§æ‡§ï‡•Ä</div><div className="text-3xl font-extrabold">{jobs.filter(j=>j.status==="pending"||j.status==="in-progress").length}</div></div>
            <div className="bg-emerald-500/90 rounded-xl px-5 py-4 text-white flex-1"><div className="text-[11px] uppercase tracking-wider opacity-60 mb-1">Done / ‡§™‡•Ç‡§∞‡§æ</div><div className="text-3xl font-extrabold">{jobs.filter(j=>j.status==="completed").length}</div></div>
          </div>
        </div>
      </div>
      <div className="max-w-2xl mx-auto px-5 pb-10 -mt-4">
        <div className="relative mb-6"><II.Search s={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"/><input className="w-full pl-11 pr-4 py-4 bg-white rounded-xl border border-slate-200 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search / ‡§ñ‡•ã‡§ú‡•á‡§Ç..." value={q} onChange={e=>setQ(e.target.value)}/></div>
        {pend.length>0&&<div className="mb-8"><h2 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><II.Clock s={16} className="text-amber-600"/>‡§Ü‡§ú ‡§ú‡§æ‡§®‡§æ ‡§π‡•à / Today ({pend.length})</h2><div className="space-y-4">{pend.map(j=><div key={j.id} className="bg-white rounded-xl border-l-4 shadow-sm p-5" style={{borderLeftColor:C.red}}>
          <div className="flex items-start gap-3 mb-4"><II.Pin s={20} style={{color:C.red}} className="flex-shrink-0 mt-0.5"/><div className="flex-1"><p className="font-bold text-base text-slate-900">{j.address}</p>{j.customer_name&&<p className="text-sm text-slate-500 mt-1">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: {j.customer_name}</p>}{j.customer_phone&&<p className="text-sm text-slate-500">üìû {j.customer_phone}</p>}<p className="text-xs text-slate-400 mt-1">{j.area}</p><div className="mt-2"><SBadge s={j.status}/></div></div></div>
          <div className="flex gap-3"><button onClick={()=>window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(j.address)}`,"_blank")} className="flex-1 py-3.5 border-2 rounded-xl font-bold text-sm hover:bg-blue-50 flex items-center justify-center gap-2 transition" style={{borderColor:C.pri,color:C.pri}}><II.Pin s={18}/>‡§®‡§ï‡•ç‡§∂‡§æ / Map</button><button onClick={()=>onStart(j.id)} className="flex-1 py-3.5 text-white rounded-xl font-bold text-sm shadow flex items-center justify-center gap-2 hover:opacity-90 transition" style={{background:"#059669"}}><II.Play s={18}/>‡§ï‡§æ‡§Æ ‡§∂‡•Å‡§∞‡•Ç / Start</button></div>
        </div>)}</div></div>}
        {pend.length===0&&!q&&<div className="bg-white rounded-xl p-12 text-center shadow-sm mb-8"><div className="text-5xl mb-3">üéâ</div><h3 className="text-xl font-bold mb-1">‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! All Done!</h3><p className="text-slate-500">‡§Ü‡§ú ‡§ï‡•á ‡§∏‡§æ‡§∞‡•á ‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡•á ‡§π‡•ã ‡§ó‡§è</p></div>}
        {oth.length>0&&<div className="mb-8"><h2 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Other ({oth.length})</h2><div className="space-y-2">{oth.map(j=><div key={j.id} className="bg-white rounded-xl border p-4 flex items-center justify-between"><div><p className="font-medium text-sm">{j.address}</p>{j.customer_name&&<p className="text-xs text-slate-500 mt-0.5">{j.customer_name}</p>}</div><SBadge s={j.status}/></div>)}</div></div>}
        {comp.length>0&&<div><h2 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2"><II.Ok s={16} className="text-emerald-600"/>‡§™‡•Ç‡§∞‡•á ‡§π‡•Å‡§è / Completed ({comp.length})</h2><div className="space-y-2">{comp.map(j=><div key={j.id} className="bg-white rounded-xl border border-emerald-200 p-4 flex items-center justify-between"><div className="flex items-start gap-3 flex-1"><II.Ok s={16} className="text-emerald-600 flex-shrink-0 mt-0.5"/><div><p className="font-medium text-sm">{j.address}</p>{j.customer_name&&<p className="text-xs text-slate-500 mt-0.5">{j.customer_name}</p>}{j.payment_amount&&<p className="text-xs text-emerald-700 font-semibold mt-1">‚Çπ{j.payment_amount} ({(j.payment_type||"").toUpperCase()})</p>}</div></div>{j.receipt_number&&<Bdg v="outline">{j.receipt_number}</Bdg>}</div>)}</div></div>}
      </div>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Inspection Workflow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function Inspect({ job, onDone, onBack, onUpd, show }) {
  const [step, setStep] = useState("arrival"); const [jS, setJS] = useState("in-progress"); const [reason, setReason] = useState(""); const [vPhoto, setVPhoto] = useState(""); const [cl, setCl] = useState({pipe_condition:null,leak_test:null,regulator_condition:null}); const [pay, setPay] = useState({type:"",amount:"",upi:""}); const [rcpt, setRcpt] = useState(""); const [saving, setSaving] = useState(false); const [gps, setGps] = useState(null); const [gpsErr, setGpsErr] = useState(""); const [gpsLd, setGpsLd] = useState(false); const pRef = useRef(null); const rcptRef = useRef(null);
  const steps=["arrival","status","checklist","payment","receipt"]; const prog=((steps.indexOf(step)+1)/steps.length)*100;
  const BB=({onClick,children,color,disabled})=><button onClick={onClick} disabled={disabled||saving} className={`w-full py-5 rounded-xl font-extrabold text-lg text-white shadow-lg transition active:scale-[0.98] disabled:opacity-40`} style={{background:color||"#059669"}}>{saving?<II.Spin s={20} className="animate-spin mx-auto"/>:children}</button>;
  const CO=({label,labelEn,sel,onSel,y="ok",n="not-ok",yL="‡§π‡§æ‡§Å / YES",nL="‡§®‡§π‡•Ä‡§Ç / NO",emoji})=><div className="p-5 bg-white rounded-xl border-2 border-slate-200 mb-4"><div className="flex items-center gap-3 mb-4"><div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center text-2xl">{emoji}</div><div><p className="font-bold text-base">{label}</p><p className="text-sm text-slate-500">{labelEn}</p></div></div><div className="grid grid-cols-2 gap-3"><button onClick={()=>onSel(y)} className={`py-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition ${sel===y?"bg-emerald-600 text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`}><II.Ok s={18}/>{yL}</button><button onClick={()=>onSel(n)} className={`py-4 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition ${sel===n?"text-white shadow":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`} style={sel===n?{background:C.red}:{}}><II.No s={18}/>{nL}</button></div></div>;

  const doArrival=async()=>{
    setGpsLd(true); setGpsErr("");
    if(!navigator.geolocation){setGpsErr("GPS not supported on this device");setGpsLd(false);return;}
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude,lng=pos.coords.longitude;
      setGps({lat,lng}); setGpsLd(false);
      const now=new Date().toISOString();
      onUpd({status:"in-progress",arrival_time:now,gps_lat:lat,gps_lng:lng});
      setStep("status");
    },err=>{
      if(err.code===1) setGpsErr("Location permission denied. Please enable GPS and try again.");
      else if(err.code===2) setGpsErr("Location unavailable. Please try again.");
      else setGpsErr("Location timed out. Please try again.");
      setGpsLd(false);
    },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
  };
  const doPhoto=e=>{const f=e.target.files?.[0];if(f){const r=new FileReader();r.onloadend=()=>setVPhoto(r.result);r.readAsDataURL(f);}};
  const doNonComplete=async()=>{if(vPhoto&&reason){setSaving(true);await onUpd({status:jS,status_reason:reason,completed_time:new Date().toISOString()});setSaving(false);onBack();}};
  const doPayDone=()=>{if(pay.type&&pay.amount){setRcpt(`RC${String(Math.floor(Math.random()*9999)+1).padStart(4,"0")}`);setStep("receipt");}};
  const doFinal=async()=>{setSaving(true);await onDone({...cl,payment_type:pay.type,payment_amount:parseInt(pay.amount),upi_transaction_id:pay.upi||null,receipt_number:rcpt,status:"completed",completed_time:new Date().toISOString()});setSaving(false);};
  const shareR=()=>{const m=`${APP_NAME}\nReceipt: ${rcpt}\nCustomer: ${job.customer_name||"N/A"}\nAddress: ${job.address}\n${job.gas_company_name?`Company: ${job.gas_company_name}\n`:""}Amount: ‚Çπ${pay.amount} (${pay.type.toUpperCase()})\nDate: ${new Date().toLocaleDateString("en-IN")}`;window.open(`https://wa.me/?text=${encodeURIComponent(m)}`,"_blank");};
  const printReceipt=()=>{const w=window.open("","_blank","width=400,height=600");if(!w)return;w.document.write(`<!DOCTYPE html><html><head><title>Receipt ${rcpt}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:24px;max-width:400px;margin:0 auto;color:#1a1a1a}.hdr{text-align:center;border-bottom:2px solid #0f2557;padding-bottom:16px;margin-bottom:16px}.hdr h1{font-size:18px;color:#0f2557;margin-bottom:2px}.hdr p{font-size:11px;color:#666}.rcn{text-align:center;font-size:24px;font-weight:900;color:#0f2557;margin:12px 0;letter-spacing:2px}.row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #eee}.row .l{color:#666}.row .v{font-weight:600;text-align:right;max-width:55%}.amt{background:#f0fdf4;border:2px solid #059669;border-radius:8px;padding:12px;margin:16px 0;text-align:center}.amt .n{font-size:24px;font-weight:900;color:#059669}.chk{margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px}.chk h3{font-size:12px;text-transform:uppercase;color:#666;margin-bottom:8px}.chk .item{display:flex;justify-content:space-between;padding:4px 0;font-size:12px}.ok{color:#059669;font-weight:700}.bad{color:#dc2626;font-weight:700}.ftr{text-align:center;margin-top:20px;padding-top:12px;border-top:1px dashed #ccc;font-size:10px;color:#999}@media print{body{padding:12px}}</style></head><body><div class="hdr"><h1>${APP_NAME}</h1><p>Gas Safety Inspection Receipt</p></div><div class="rcn">${rcpt}</div><div class="row"><span class="l">Date:</span><span class="v">${new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"long",year:"numeric"})}</span></div><div class="row"><span class="l">Time:</span><span class="v">${new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})}</span></div><div class="row"><span class="l">Customer:</span><span class="v">${job.customer_name||"N/A"}</span></div><div class="row"><span class="l">Address:</span><span class="v">${job.address}</span></div>${job.customer_phone?`<div class="row"><span class="l">Phone:</span><span class="v">${job.customer_phone}</span></div>`:""}${job.gas_company_name?`<div class="row"><span class="l">Gas Company:</span><span class="v">${job.gas_company_name}</span></div>`:""}${job.gas_agency_name?`<div class="row"><span class="l">Gas Agency:</span><span class="v">${job.gas_agency_name}</span></div>`:""}<div class="amt"><div style="font-size:12px;color:#666;margin-bottom:4px">Amount Paid</div><div class="n">‚Çπ${pay.amount}</div><div style="font-size:11px;color:#666;margin-top:4px">${pay.type.toUpperCase()}${pay.upi?` ‚Ä¢ ${pay.upi}`:""}</div></div><div class="chk"><h3>Safety Inspection Results</h3><div class="item"><span>Gas Pipe Condition</span><span class="${cl.pipe_condition==="ok"?"ok":"bad"}">${cl.pipe_condition==="ok"?"‚úì OK":"‚úó Issue"}</span></div><div class="item"><span>Leak Test</span><span class="${cl.leak_test==="ok"?"ok":"bad"}">${cl.leak_test==="ok"?"‚úì OK":"‚úó Issue"}</span></div><div class="item"><span>Regulator</span><span class="${cl.regulator_condition==="good"?"ok":"bad"}">${cl.regulator_condition==="good"?"‚úì Good":"‚úó Bad"}</span></div></div><div class="ftr"><p>${APP_NAME}</p><p>Thank you for your cooperation</p></div></body></html>`);w.document.close();setTimeout(()=>w.print(),300);};

  return (
    <div className="min-h-screen" style={{background:C.bg}}>
      <div className="px-5 pt-4 pb-6" style={{background:`linear-gradient(135deg,#059669,#047857)`}}><div className="max-w-2xl mx-auto"><button onClick={onBack} className="flex items-center gap-1.5 text-white/70 hover:text-white text-sm mb-3"><II.Back s={18}/>Back / ‡§µ‡§æ‡§™‡§∏</button><div className="flex items-start gap-3"><II.Pin s={20} className="text-white flex-shrink-0 mt-1"/><div><h1 className="text-lg font-extrabold text-white leading-tight">{job.address}</h1>{job.customer_name&&<p className="text-emerald-100 text-sm mt-1">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï: {job.customer_name}</p>}{job.customer_phone&&<p className="text-emerald-100 text-sm">üìû {job.customer_phone}</p>}</div></div><div className="mt-4 bg-white/20 rounded-full h-2.5 overflow-hidden"><div className="h-full bg-white rounded-full transition-all duration-500" style={{width:`${prog}%`}}/></div><p className="text-emerald-100 text-xs mt-2">Step {steps.indexOf(step)+1} of {steps.length}</p></div></div>
      <div className="max-w-2xl mx-auto px-5 pb-10 -mt-2">
        {step==="arrival"&&<div className="bg-white rounded-xl shadow-sm p-8 text-center"><div className="w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-5" style={{background:"#e8edf5"}}><II.Loc s={40} style={{color:C.pri}}/></div><h2 className="text-2xl font-extrabold mb-1">‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§™‡§π‡•Å‡§Å‡§ö ‡§ó‡§è?</h2><p className="text-lg text-slate-500 mb-6">Did you reach the location?</p><div className="bg-slate-50 rounded-xl p-4 mb-6 text-left"><p className="text-xs text-slate-500 mb-1 uppercase font-semibold">Location:</p><p className="font-bold">{job.address}</p></div>{gpsErr&&<div className="bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg px-4 py-3 mb-4 text-left flex items-start gap-2"><II.Warn s={18} className="flex-shrink-0 mt-0.5"/><div><p className="font-semibold">Location Error</p><p className="text-xs mt-0.5">{gpsErr}</p></div></div>}{gps&&<div className="bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm rounded-lg px-4 py-3 mb-4 text-left"><p className="font-semibold">‚úì Location captured</p><p className="text-xs mt-0.5 font-mono">{gps.lat.toFixed(6)}, {gps.lng.toFixed(6)}</p></div>}<BB onClick={doArrival} disabled={gpsLd} color={C.pri}><span className="flex items-center justify-center gap-2">{gpsLd?<II.Spin s={24} className="animate-spin"/>:<II.Loc s={24}/>}{gpsLd?"Getting location...":"Confirm Arrival / ‡§™‡§π‡•Å‡§Å‡§ö ‡§ó‡§Ø‡§æ"}</span></BB><p className="text-xs text-slate-400 mt-3">GPS location will be verified and recorded</p></div>}

        {step==="status"&&<div className="bg-white rounded-xl shadow-sm p-6"><h2 className="text-xl font-extrabold text-center mb-1">‡§ï‡•ç‡§Ø‡§æ ‡§π‡•Å‡§Ü?</h2><p className="text-sm text-slate-500 text-center mb-6">What happened?</p><div className="space-y-3">{[{s:"completed",e:"‚úÖ",h:"‡§ï‡§æ‡§Æ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü",n:"Work Completed"},{s:"customer-not-reachable",e:"üö´",h:"‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ",n:"Not Reachable"},{s:"customer-refused",e:"üôÖ",h:"‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§®‡•á ‡§Æ‡§®‡§æ ‡§ï‡§ø‡§Ø‡§æ",n:"Refused"},{s:"rescheduled",e:"üìÖ",h:"‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§§‡§Ø ‡§ï‡§∞‡§®‡§æ ‡§π‡•à",n:"Reschedule"}].map(o=><button key={o.s} onClick={()=>{setJS(o.s);if(o.s==="completed")setStep("checklist");}} className={`w-full py-5 rounded-xl font-bold text-base flex items-center gap-4 px-5 border-2 transition ${jS===o.s&&o.s!=="completed"?"text-white":"border-slate-200 hover:border-slate-400"}`} style={jS===o.s&&o.s!=="completed"?{background:C.pri,borderColor:C.pri}:{}}><span className="text-2xl">{o.e}</span><div className="text-left"><div>{o.h}</div><div className="text-sm opacity-70 font-normal">{o.n}</div></div></button>)}</div>
          {jS!=="completed"&&jS!=="in-progress"&&<div className="mt-6 p-5 bg-amber-50 border-2 border-amber-300 rounded-xl space-y-4"><p className="font-bold text-amber-900">Proof Required / ‡§∏‡§¨‡•Ç‡§§ ‡§ö‡§æ‡§π‡§ø‡§è</p><div><input ref={pRef} type="file" accept="image/*" capture="environment" className="hidden" onChange={doPhoto}/><button onClick={()=>pRef.current?.click()} className="w-full py-4 border-2 border-dashed border-amber-400 rounded-xl font-bold text-sm text-amber-700 hover:bg-amber-100 flex items-center justify-center gap-2"><II.Cam s={20}/>{vPhoto?"‚úì Photo Taken":"Take Photo / ‡§´‡•ã‡§ü‡•ã ‡§≤‡•á‡§Ç"}</button>{vPhoto&&<img src={vPhoto} alt="" className="mt-3 rounded-xl max-h-40 w-full object-cover"/>}</div><div><label className="block text-sm font-semibold text-amber-900 mb-1.5">Reason / ‡§ï‡§æ‡§∞‡§£ *</label><textarea className="w-full px-4 py-3 border border-amber-300 rounded-xl text-sm bg-white focus:outline-none focus:ring-2 focus:ring-amber-500" rows={3} value={reason} onChange={e=>setReason(e.target.value)} placeholder="Write reason..."/></div><BB onClick={doNonComplete} disabled={!vPhoto||!reason} color="#b45309">Submit & Return</BB></div>}
        </div>}

        {step==="checklist"&&<div><div className="text-center mb-6"><h2 className="text-xl font-extrabold">‡§∏‡•á‡§´‡•ç‡§ü‡•Ä ‡§ö‡•á‡§ï‡§≤‡§ø‡§∏‡•ç‡§ü</h2><p className="text-sm text-slate-500">Safety Checklist</p></div><CO label="‡§ó‡•à‡§∏ ‡§™‡§æ‡§á‡§™ ‡§†‡•Ä‡§ï ‡§π‡•à?" labelEn="Gas Pipe Condition" emoji="üîß" sel={cl.pipe_condition} onSel={v=>setCl({...cl,pipe_condition:v})}/><CO label="‡§≤‡•Ä‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ?" labelEn="Leak Test Result" emoji="üîç" sel={cl.leak_test} onSel={v=>setCl({...cl,leak_test:v})}/><CO label="‡§∞‡•á‡§ó‡•Å‡§≤‡•á‡§ü‡§∞ ‡§†‡•Ä‡§ï ‡§π‡•à?" labelEn="Regulator Condition" emoji="‚öôÔ∏è" sel={cl.regulator_condition} onSel={v=>setCl({...cl,regulator_condition:v})} y="good" n="bad" yL="‡§Ö‡§ö‡•ç‡§õ‡§æ / GOOD" nL="‡§ñ‡§∞‡§æ‡§¨ / BAD"/>{cl.pipe_condition&&cl.leak_test&&cl.regulator_condition?<BB onClick={()=>setStep("payment")} color={C.pri}>‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç / Continue ‚Üí</BB>:<div className="mt-3 p-4 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-2 text-sm text-amber-800"><II.Warn s={16}/>Complete all checks to continue</div>}</div>}

        {step==="payment"&&<div className="bg-white rounded-xl shadow-sm p-6"><div className="text-center mb-6"><div className="text-4xl mb-2">üí∞</div><h2 className="text-2xl font-extrabold">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§≤‡•á‡§Ç</h2><p className="text-slate-500">Collect Payment</p></div><div className="grid grid-cols-3 gap-3 mb-6">{[{t:"cash",e:"üíµ",h:"‡§®‡§ï‡§¶",n:"CASH"},{t:"upi",e:"üì±",h:"UPI",n:"UPI"},{t:"already-paid",e:"‚úÖ",h:"‡§™‡§π‡§≤‡•á ‡§¶‡§ø‡§Ø‡§æ",n:"PAID"}].map(p=><button key={p.t} onClick={()=>setPay({...pay,type:p.t})} className={`py-5 rounded-xl font-bold text-sm flex flex-col items-center gap-2 border-2 transition ${pay.type===p.t?"border-emerald-600 bg-emerald-50 text-emerald-800":"border-slate-200 hover:border-slate-400"}`}><span className="text-2xl">{p.e}</span>{p.h}<span className="text-[10px] opacity-60">{p.n}</span></button>)}</div>{pay.type==="upi"&&<div className="mb-5 p-4 bg-violet-50 border-2 border-violet-200 rounded-xl"><button onClick={()=>setPay({...pay,upi:`UPI${Date.now()}`})} className="w-full py-4 border-2 border-violet-400 rounded-xl font-bold text-sm text-violet-700 flex items-center justify-center gap-2"><II.QR s={20}/>{pay.upi?"‚úì Scanned":"Scan QR"}</button>{pay.upi&&<div className="mt-2 p-2 bg-emerald-100 rounded-lg text-xs text-emerald-800 text-center font-mono">‚úì {pay.upi}</div>}</div>}{pay.type&&<div className="mb-6"><p className="font-bold text-center mb-3 text-sm uppercase text-slate-500">Amount / ‡§∞‡§æ‡§∂‡§ø</p><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-extrabold text-slate-400">‚Çπ</span><input type="number" className="w-full pl-12 pr-4 py-5 border-2 border-slate-200 rounded-xl text-3xl font-extrabold text-center focus:outline-none focus:ring-2 focus:ring-emerald-500" value={pay.amount} onChange={e=>setPay({...pay,amount:e.target.value})} placeholder="200"/></div></div>}{pay.type&&pay.amount&&(pay.type!=="upi"||pay.upi)&&<BB onClick={doPayDone}>‡§∞‡§∏‡•Ä‡§¶ ‡§¨‡§®‡§æ‡§è‡§Ç / Generate Receipt</BB>}</div>}

        {step==="receipt"&&<div ref={rcptRef} className="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
          <div className="p-5 text-center border-b-2" style={{background:C.pri,borderColor:C.red}}><h2 className="text-xl font-extrabold text-white">{APP_NAME}</h2><p className="text-blue-200/80 text-xs mt-0.5">Gas Safety Inspection Receipt</p></div>
          <div className="p-6">
            <div className="text-center mb-5"><p className="text-3xl font-extrabold tracking-widest" style={{color:C.pri}}>{rcpt}</p><p className="text-xs text-slate-400 mt-1 uppercase">Receipt Number</p></div>
            <div className="border border-slate-200 rounded-lg overflow-hidden mb-5"><table className="w-full text-sm">{[["Date",new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"long",year:"numeric"})],["Time",new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})],["Customer",job.customer_name||"N/A"],["Address",job.address],...(job.customer_phone?[["Phone",job.customer_phone]]:[]),...(job.gas_company_name?[["Gas Company",job.gas_company_name]]:[]),...(job.gas_agency_name?[["Gas Agency",job.gas_agency_name]]:[])].map(([l,v],i)=><tr key={i} className={i%2===0?"bg-slate-50":""}><td className="px-4 py-2.5 text-slate-500 font-medium border-r border-slate-200 w-[40%]">{l}</td><td className="px-4 py-2.5 font-semibold">{v}</td></tr>)}</table></div>
            <div className="bg-emerald-50 border-2 border-emerald-500 rounded-lg p-5 text-center mb-5"><p className="text-xs text-emerald-600 uppercase font-bold mb-1">Amount Paid</p><p className="text-3xl font-extrabold text-emerald-700">‚Çπ{pay.amount}</p><p className="text-sm text-emerald-600 mt-1">{pay.type.toUpperCase()}{pay.upi?` ‚Ä¢ ${pay.upi}`:""}</p></div>
            <div className="border border-slate-200 rounded-lg p-4 mb-6"><p className="text-xs font-bold text-slate-500 uppercase mb-3">Safety Inspection Results</p>{[["Gas Pipe",cl.pipe_condition,"ok"],["Leak Test",cl.leak_test,"ok"],["Regulator",cl.regulator_condition,"good"]].map(([l,v,ok])=><div key={l} className="flex justify-between items-center py-2 border-b border-slate-100 last:border-0"><span className="text-sm text-slate-600">{l}</span><Bdg v={v===ok?"success":"danger"}>{v===ok?"‚úì OK":"‚úó Issue"}</Bdg></div>)}</div>
            <div className="grid grid-cols-3 gap-3"><button onClick={shareR} className="py-3.5 border border-slate-200 rounded-lg font-semibold text-xs hover:bg-slate-50 flex flex-col items-center gap-1"><II.Share s={18} className="text-slate-500"/>WhatsApp</button><button onClick={printReceipt} className="py-3.5 border border-slate-200 rounded-lg font-semibold text-xs hover:bg-slate-50 flex flex-col items-center gap-1" style={{color:C.pri}}><II.Pdf s={18}/>Print PDF</button><button onClick={doFinal} disabled={saving} className="py-3.5 text-white rounded-lg font-semibold text-xs flex flex-col items-center gap-1" style={{background:"#059669"}}>{saving?<II.Spin s={18} className="animate-spin"/>:<II.Ok s={18}/>}Complete</button></div>
          </div>
        </div>}
      </div>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Reconciliation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
function Recon({ emps, jobs, onBack }) {
  const c=jobs.filter(j=>j.status==="completed"),p=jobs.filter(j=>j.status==="pending"||j.status==="in-progress");
  const ct=c.filter(j=>j.payment_type==="cash").reduce((s,j)=>s+(+j.payment_amount||0),0),ut=c.filter(j=>j.payment_type==="upi").reduce((s,j)=>s+(+j.payment_amount||0),0),ap=c.filter(j=>j.payment_type==="already-paid").reduce((s,j)=>s+(+j.payment_amount||0),0);
  const es=emps.map(e=>{const ej=jobs.filter(j=>j.assigned_to===e.id),ec=ej.filter(j=>j.status==="completed");return{e,tot:ej.length,done:ec.length,pend:ej.filter(j=>j.status==="pending"||j.status==="in-progress").length,cash:ec.filter(j=>j.payment_type==="cash").reduce((s,j)=>s+(+j.payment_amount||0),0),upi:ec.filter(j=>j.payment_type==="upi").reduce((s,j)=>s+(+j.payment_amount||0),0),ap:ec.filter(j=>j.payment_type==="already-paid").reduce((s,j)=>s+(+j.payment_amount||0),0),jobs:ec};});
  return (
    <div className="min-h-screen" style={{background:`linear-gradient(135deg,${C.pri},#1a3a7a)`}}>
      <div className="px-4 sm:px-6 pt-4 pb-6 max-w-5xl mx-auto"><div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"><div><button onClick={onBack} className="flex items-center gap-1.5 text-white/70 hover:text-white text-sm mb-2"><II.Back s={18}/>Back</button><h1 className="text-2xl sm:text-3xl font-extrabold text-white">Reconciliation</h1><p className="text-blue-200/70 text-sm mt-1">{new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</p></div><button onClick={()=>window.print()} className="flex items-center gap-2 px-4 py-2.5 bg-white/15 text-white rounded-lg text-sm font-semibold hover:bg-white/25"><II.Print s={16}/>Print</button></div></div>
      <div className="max-w-5xl mx-auto px-4 sm:px-6 pb-10">
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">{[{l:"Total",v:jobs.length},{l:"Done",v:c.length},{l:"Pending",v:p.length},{l:"Rate",v:`${jobs.length?Math.round(c.length/jobs.length*100):0}%`}].map((s,i)=><div key={i} className="bg-white/10 backdrop-blur rounded-xl p-4 text-white text-center"><div className="text-3xl font-extrabold">{s.v}</div><div className="text-xs uppercase opacity-60 mt-1">{s.l}</div></div>)}</div>
        <div className="bg-white rounded-xl shadow-lg p-5 mb-6"><h2 className="text-lg font-bold mb-4">Payment Summary</h2><div className="space-y-3">{[{l:"Cash",v:ct,c:"bg-amber-50 text-amber-700",i:"üíµ"},{l:"UPI",v:ut,c:"bg-violet-50 text-violet-700",i:"üì±"},{l:"Already Paid",v:ap,c:"bg-blue-50 text-blue-700",i:"‚úÖ"}].map(p=><div key={p.l} className={`flex items-center justify-between p-4 rounded-lg ${p.c}`}><span className="flex items-center gap-2 font-medium"><span className="text-lg">{p.i}</span>{p.l}</span><span className="text-xl font-extrabold">‚Çπ{p.v}</span></div>)}<div className="flex items-center justify-between p-4 bg-emerald-100 rounded-lg border-2 border-emerald-500"><span className="font-extrabold text-lg text-emerald-900">GRAND TOTAL</span><span className="text-2xl font-extrabold text-emerald-700">‚Çπ{ct+ut+ap}</span></div></div></div>
        <div className="bg-white rounded-xl shadow-lg p-5"><h2 className="text-lg font-bold mb-4">Employee Breakdown</h2><div className="space-y-5">{es.map(s=><div key={s.e.id} className="border-2 border-slate-200 rounded-xl p-5"><div className="flex items-center justify-between mb-4 pb-3 border-b border-slate-100"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-lg flex items-center justify-center" style={{background:"#e8edf5"}}><II.User s={18} style={{color:C.pri}}/></div><div><h3 className="font-bold">{s.e.name}</h3><p className="text-xs text-slate-500">{s.e.phone} ‚Ä¢ {s.e.area}</p></div></div><div className="text-right"><div className="text-xl font-extrabold text-emerald-600">‚Çπ{s.cash+s.upi+s.ap}</div><div className="text-[10px] text-slate-500 uppercase">Collection</div></div></div><div className="grid grid-cols-5 gap-2 text-center mb-4">{[{v:s.tot,l:"Total",c:"bg-slate-50"},{v:s.done,l:"Done",c:"bg-emerald-50"},{v:s.pend,l:"Pend",c:"bg-amber-50"},{v:`‚Çπ${s.cash}`,l:"Cash",c:"bg-orange-50"},{v:`‚Çπ${s.upi}`,l:"UPI",c:"bg-violet-50"}].map((d,i)=><div key={i} className={`${d.c} rounded-lg py-2`}><div className="text-lg font-extrabold">{d.v}</div><div className="text-[9px] text-slate-500 uppercase">{d.l}</div></div>)}</div>{s.jobs.length>0&&<div><p className="text-xs font-semibold text-slate-500 mb-2 uppercase">Completed:</p><div className="space-y-1.5">{s.jobs.map(j=><div key={j.id} className="flex items-center justify-between text-sm p-3 bg-slate-50 rounded-lg"><div><div className="font-medium">{j.address}</div><div className="text-xs text-slate-500">{j.customer_name&&`${j.customer_name} ‚Ä¢ `}{j.receipt_number}</div></div><div className="text-right"><div className="font-bold">‚Çπ{j.payment_amount}</div><Bdg v="outline">{(j.payment_type||"").toUpperCase()}</Bdg></div></div>)}</div></div>}</div>)}</div></div>
      </div>
    </div>
  );
}

/*‚îÄ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
export default function App() {
  const [user, setUser] = useState(null); const [prof, setProf] = useState(null); const [myEmpId, setMyEmpId] = useState(null);
  const [authLd, setAuthLd] = useState(true); const [view, setView] = useState("loading"); const [selE, setSelE] = useState(""); const [selJ, setSelJ] = useState("");
  const db = useData();
  const resolveRole = async (u) => { setUser(u); const { data: p } = await sb.from("profiles").select("*").eq("id", u.id).single(); setProf(p); if (p?.role === "employee") { const { data: el } = await sb.from("employees").select("*").eq("profile_id", u.id); if (el?.[0]) { setMyEmpId(el[0].id); setView("emp-direct"); } else setView("emp-unlinked"); } else setView("admin"); };
  useEffect(() => { (async () => { const { data: { user: u } } = await sb.auth.getUser(); if (u) await resolveRole(u); else setView("login"); setAuthLd(false); })(); }, []);
  const onLogin = async u => await resolveRole(u);
  const onLogout = async () => { await sb.auth.signOut(); setUser(null); setProf(null); setMyEmpId(null); setView("login"); };
  const onComplete = async (jobId, upd) => { await db.updJob(jobId, upd); setView(myEmpId ? "emp-direct" : "emp"); db.load(); };

  if (authLd) return <div className="min-h-screen flex items-center justify-center" style={{background:C.pri}}><div className="text-center"><div className="w-16 h-16 rounded-2xl bg-white/10 flex items-center justify-center mx-auto mb-4"><II.Loc s={32} className="text-white"/></div><II.Spin s={32} className="animate-spin text-blue-400 mx-auto"/><p className="text-blue-200/60 text-sm mt-4">Loading {APP_NAME}...</p></div></div>;
  if (view === "login" || !user) return <Login onOk={onLogin}/>;
  if (view === "emp-unlinked") return <div className="min-h-screen flex items-center justify-center p-4" style={{background:C.pri}}><div className="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center"><div className="text-5xl mb-4">‚ö†Ô∏è</div><h2 className="text-xl font-bold mb-2">Account Not Linked</h2><p className="text-slate-500 text-sm mb-6">Your login isn't linked to an employee record. Contact your admin.</p><p className="text-xs text-slate-400 mb-4">{user.email}</p><button onClick={onLogout} className="w-full py-3 text-white rounded-lg font-semibold text-sm" style={{background:C.pri}}>Logout</button></div></div>;

  return (
    <div className="min-h-screen" style={{background:C.bg}}>
      {db.toast && <Toast msg={db.toast.msg} type={db.toast.type} onClose={() => db.setToast(null)} />}
      {db.loading && (view === "admin" || view === "emp-direct") && <div className="flex justify-center py-20"><II.Spin s={32} className="animate-spin" style={{color:C.pri}}/></div>}
      {!db.loading && view === "admin" && <Admin emps={db.emps} jobs={db.jobs} onAddEmp={db.addEmp} onAddJob={db.addJob} onBulk={db.addBulk} onUpdJob={db.updJob} onRecon={() => setView("recon")} onViewEmp={id => { setSelE(id); setView("emp"); }} onLogout={onLogout} prof={prof} show={db.show}/>}
      {view === "emp" && <EmpView emp={db.emps.find(e => e.id === selE)} jobs={db.jobs.filter(j => j.assigned_to === selE)} onStart={id => { setSelJ(id); setView("inspect"); }} onBack={() => { setView("admin"); db.load(); }}/>}
      {!db.loading && view === "emp-direct" && <EmpView emp={db.emps.find(e => e.id === myEmpId)} jobs={db.jobs.filter(j => j.assigned_to === myEmpId)} onStart={id => { setSelJ(id); setView("inspect-emp"); }} onLogout={onLogout} isDirectLogin/>}
      {view === "inspect-emp" && <Inspect job={db.jobs.find(j => j.id === selJ)} onDone={u => onComplete(selJ, u)} onBack={() => { setView("emp-direct"); db.load(); }} onUpd={u => db.updJob(selJ, u)} show={db.show}/>}
      {view === "inspect" && <Inspect job={db.jobs.find(j => j.id === selJ)} onDone={u => onComplete(selJ, u)} onBack={() => { setView("emp"); db.load(); }} onUpd={u => db.updJob(selJ, u)} show={db.show}/>}
      {view === "recon" && <Recon emps={db.emps} jobs={db.jobs} onBack={() => setView("admin")}/>}
    </div>
  );
}
